<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignalWrite - Professional Writing Editor</title>
    
    <!-- Google Analytics - REPLACE WITH YOUR TAG -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W5644J7XBD"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-W5644J7XBD');
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-dark: #1A1D2E;
            --surface-dark: #252938;
            --text-dark: #E8EAF0;
            --text-secondary-dark: #9B9FB4;
            --bg-light: #FAFBFC;
            --surface-light: #FFFFFF;
            --text-light: #1F2937;
            --text-secondary-light: #6B7280;
            --accent: #6366F1;
            --accent-hover: #4F46E5;
            --success: #10B981;
            --error: #EF4444;
            --warning: #F59E0B;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text-dark);
            min-height: 100vh;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: text;
            -webkit-user-select: text;
        }

        body.light-theme {
            background: var(--bg-light);
            color: var(--text-light);
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .light-theme .header {
            background: rgba(250, 251, 252, 0.85);
            border-bottom-color: rgba(0, 0, 0, 0.06);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.06);
            color: var(--text-dark);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .light-theme .back-btn {
            background: rgba(0, 0, 0, 0.04);
            color: var(--text-light);
        }

        .back-btn:hover {
            background: rgba(99, 102, 241, 0.12);
            transform: translateX(-2px);
        }

        .logo {
            font-size: 19px;
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--accent), #8B5CF6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .export-btn {
            background: linear-gradient(135deg, var(--accent), #8B5CF6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.35);
        }

        /* Main Container */
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px 160px;
        }

        .subject-field {
            background: none;
            border: none;
            outline: none;
            font-size: 26px;
            font-weight: 700;
            padding: 32px 0 20px;
            color: inherit;
            width: 100%;
            letter-spacing: -0.5px;
        }

        .subject-field::placeholder {
            color: var(--text-secondary-dark);
            opacity: 0.5;
        }

        .light-theme .subject-field::placeholder {
            color: var(--text-secondary-light);
        }

        .editor {
            min-height: 400px;
            outline: none;
            font-family: 'Charter', 'Georgia', serif;
            font-size: 18px;
            line-height: 1.75;
            color: inherit;
            padding: 12px 0;
        }

        .editor:empty:before {
            content: "Start writing...";
            color: var(--text-secondary-dark);
            opacity: 0.5;
        }

        .light-theme .editor:empty:before {
            color: var(--text-secondary-light);
        }

        /* Bottom Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .light-theme .bottom-bar {
            background: rgba(250, 251, 252, 0.85);
            border-top-color: rgba(0, 0, 0, 0.06);
        }

        .refine-container {
            padding: 16px 24px 12px;
            text-align: center;
        }

        .refine-btn {
            background: linear-gradient(135deg, var(--accent), #8B5CF6);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        .refine-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(99, 102, 241, 0.4);
        }

        .refine-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .bottom-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            font-size: 14px;
            color: var(--text-secondary-dark);
        }

        .light-theme .bottom-info {
            color: var(--text-secondary-light);
        }

        .info-left {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .info-link {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .info-link:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
        }

        /* Theme Toggle */
        .theme-switch {
            position: relative;
            width: 54px;
            height: 28px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #2A2F3F;
            transition: 0.3s;
            border-radius: 34px;
        }

        .light-theme .slider {
            background: #D1D5DB;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background: var(--accent);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Modal Base */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 200;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            width: 100%;
            max-width: 520px;
            max-height: 85vh;
            background: var(--surface-dark);
            border-radius: 24px;
            padding: 32px;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .light-theme .modal-content {
            background: var(--surface-light);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary-dark);
            transition: all 0.2s;
        }

        .light-theme .modal-close {
            background: rgba(0, 0, 0, 0.06);
            color: var(--text-secondary-light);
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            transform: rotate(90deg);
        }

        /* Refinement Modal */
        .refine-grid {
            display: grid;
            gap: 12px;
        }

        .refine-option {
            padding: 24px;
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .light-theme .refine-option {
            border-color: rgba(0, 0, 0, 0.08);
            background: rgba(0, 0, 0, 0.02);
        }

        .refine-option:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.08);
            transform: translateX(4px);
        }

        .refine-option-icon {
            font-size: 32px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(99, 102, 241, 0.12);
            border-radius: 12px;
        }

        .refine-option-content h3 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .refine-option-content p {
            font-size: 14px;
            color: var(--text-secondary-dark);
        }

        .light-theme .refine-option-content p {
            color: var(--text-secondary-light);
        }

        /* Export Modal */
        .export-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .export-option {
            padding: 28px 20px;
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .light-theme .export-option {
            border-color: rgba(0, 0, 0, 0.08);
            background: rgba(0, 0, 0, 0.02);
        }

        .export-option:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.08);
            transform: translateY(-4px);
        }

        .export-option-icon {
            font-size: 36px;
            margin-bottom: 12px;
        }

        .export-option-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .export-option-desc {
            font-size: 13px;
            color: var(--text-secondary-dark);
        }

        .light-theme .export-option-desc {
            color: var(--text-secondary-light);
        }

        /* History Modal */
        .history-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .clear-all-btn {
            padding: 10px 18px;
            background: rgba(239, 68, 68, 0.12);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--error);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-all-btn:hover {
            background: var(--error);
            color: white;
            transform: scale(1.02);
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 18px;
            border-radius: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.03);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .light-theme .history-item {
            border-color: rgba(0, 0, 0, 0.08);
            background: rgba(0, 0, 0, 0.02);
        }

        .history-item:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .history-item-content {
            flex: 1;
            min-width: 0;
        }

        .history-item-title {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 15px;
        }

        .history-item-preview {
            font-size: 14px;
            color: var(--text-secondary-dark);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .light-theme .history-item-preview {
            color: var(--text-secondary-light);
        }

        .history-item-date {
            font-size: 12px;
            color: var(--text-secondary-dark);
            opacity: 0.7;
            margin-top: 4px;
        }

        .history-delete-btn {
            padding: 8px;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--error);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            flex-shrink: 0;
        }

        .history-delete-btn:hover {
            background: var(--error);
            color: white;
            transform: scale(1.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary-dark);
        }

        .light-theme .empty-state {
            color: var(--text-secondary-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Status Messages */
        .status-msg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface-dark);
            color: var(--text-dark);
            padding: 20px 32px;
            border-radius: 16px;
            font-size: 16px;
            display: none;
            z-index: 300;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .status-msg {
            background: var(--surface-light);
            color: var(--text-light);
            border-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
        }

        .status-msg.active {
            display: block;
        }

        @media (max-width: 640px) {
            .main-container {
                padding-bottom: 200px;
            }
            .export-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="dark-theme">
    <header class="header">
        <div class="header-left">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <div class="logo">SignalWrite</div>
        </div>
        <button class="export-btn" onclick="showExportModal()">
            <span>‚Üó</span>
            <span>Export</span>
        </button>
    </header>

    <div class="main-container">
        <input 
            type="text" 
            class="subject-field" 
            id="subject"
            placeholder="What are we writing today?"
            onkeyup="updateWordCount(); autoSave()"
        >
        <div 
            class="editor" 
            id="editor" 
            contenteditable="true"
            onkeyup="updateWordCount(); autoSave()"
        ></div>
    </div>

    <div class="bottom-bar">
        <div class="refine-container">
            <button class="refine-btn" id="refineBtn" onclick="showRefineModal()">
                <span>‚ú®</span>
                <span>Refine Writing</span>
            </button>
        </div>
        <div class="bottom-info">
            <div class="info-left">
                <span id="wordCount">0 words ‚Ä¢ 0 chars</span>
                <span>‚Ä¢</span>
                <button class="info-link" onclick="showHistory()">üìö History</button>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 13px;">Theme</span>
                <label class="theme-switch">
                    <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="status-msg" id="statusMsg"></div>

    <!-- Refinement Modal -->
    <div class="modal" id="refineModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">AI Refinement</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="refine-grid">
                <div class="refine-option" onclick="refineText('professional')">
                    <div class="refine-option-icon">üíº</div>
                    <div class="refine-option-content">
                        <h3>Professional</h3>
                        <p>Business-ready tone</p>
                    </div>
                </div>
                <div class="refine-option" onclick="refineText('anxiety-neutralizer')">
                    <div class="refine-option-icon">üßò</div>
                    <div class="refine-option-content">
                        <h3>Confident</h3>
                        <p>Remove anxiety & uncertainty</p>
                    </div>
                </div>
                <div class="refine-option" onclick="refineText('legal')">
                    <div class="refine-option-icon">‚öñÔ∏è</div>
                    <div class="refine-option-content">
                        <h3>Legal</h3>
                        <p>Formal & precise language</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Export Document</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="export-grid">
                <div class="export-option" onclick="exportPDF()">
                    <div class="export-option-icon">üìÑ</div>
                    <div class="export-option-title">PDF</div>
                    <div class="export-option-desc">Locked format</div>
                </div>
                <div class="export-option" onclick="exportDOCX()">
                    <div class="export-option-icon">üìù</div>
                    <div class="export-option-title">Word</div>
                    <div class="export-option-desc">Editable doc</div>
                </div>
                <div class="export-option" onclick="printDocument()">
                    <div class="export-option-icon">üñ®Ô∏è</div>
                    <div class="export-option-title">Print</div>
                    <div class="export-option-desc">Physical copy</div>
                </div>
                <div class="export-option" onclick="showShareOptions()">
                    <div class="export-option-icon">üì§</div>
                    <div class="export-option-title">Share</div>
                    <div class="export-option-desc">Social media</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Share Document</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="export-grid">
                <div class="export-option" onclick="shareToWhatsApp()">
                    <div class="export-option-icon">üì±</div>
                    <div class="export-option-title">WhatsApp</div>
                </div>
                <div class="export-option" onclick="shareToTwitter()">
                    <div class="export-option-icon">üê¶</div>
                    <div class="export-option-title">Twitter/X</div>
                </div>
                <div class="export-option" onclick="shareToFacebook()">
                    <div class="export-option-icon">üìò</div>
                    <div class="export-option-title">Facebook</div>
                </div>
                <div class="export-option" onclick="shareToInstagram()">
                    <div class="export-option-icon">üì∏</div>
                    <div class="export-option-title">Instagram</div>
                </div>
                <div class="export-option" onclick="copyToClipboard()">
                    <div class="export-option-icon">üìã</div>
                    <div class="export-option-title">Copy Text</div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Document History</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="history-header-bar" style="display:none" id="historyHeaderBar">
                <button class="clear-all-btn" onclick="clearAllHistory()">üóëÔ∏è Clear All</button>
            </div>
            <div class="history-list" id="historyList">
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <div>No saved documents yet</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Copyright Protection
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || 
                (e.ctrlKey && e.shiftKey && e.key === 'C') || (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
            }
        });

        // ========== CONFIGURATION ==========
        const API_URL = 'https://signalwrite-api-clean.vercel.app';
        
        let history = JSON.parse(localStorage.getItem('signalwrite_history') || '[]');

        const $ = {
            subject: document.getElementById('subject'),
            editor: document.getElementById('editor'),
            refineBtn: document.getElementById('refineBtn'),
            wordCount: document.getElementById('wordCount'),
            statusMsg: document.getElementById('statusMsg'),
            historyList: document.getElementById('historyList'),
            themeToggle: document.getElementById('themeToggle'),
            historyHeaderBar: document.getElementById('historyHeaderBar')
        };

        // ========== THEME ==========
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            document.body.classList.toggle('dark-theme');
            localStorage.setItem('signalwrite_theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
        }

        if (localStorage.getItem('signalwrite_theme') === 'light') {
            document.body.classList.remove('dark-theme');
            document.body.classList.add('light-theme');
            $.themeToggle.checked = true;
        }

        function goBack() {
            if ($.editor.innerText.trim() || $.subject.value.trim()) {
                if (confirm('Leave editor? Unsaved changes will be lost.')) {
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        }

        // ========== WORD COUNT ==========
        function updateWordCount() {
            const text = ($.subject.value + ' ' + $.editor.innerText).trim();
            const words = text ? text.split(/\s+/).length : 0;
            const chars = text.length;
            $.wordCount.textContent = `${words} words ‚Ä¢ ${chars} chars`;
        }

        // ========== AUTO SAVE ==========
        let autoSaveTimeout;
        function autoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const subject = $.subject.value.trim();
                const content = $.editor.innerText.trim();
                if (subject || content) {
                    const draft = {
                        id: Date.now(),
                        subject: subject || 'Untitled',
                        content: content,
                        date: new Date().toISOString()
                    };
                    history.unshift(draft);
                    if (history.length > 20) history = history.slice(0, 20);
                    localStorage.setItem('signalwrite_history', JSON.stringify(history));
                    loadHistory();
                }
            }, 3000);
        }

        // ========== MODALS ==========
        function showRefineModal() {
            if (!$.editor.innerText.trim()) {
                showStatus('Please write something first!');
                return;
            }
            document.getElementById('refineModal').classList.add('active');
        }

        function showExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function showHistory() {
            loadHistory();
            document.getElementById('historyModal').classList.add('active');
        }

        function showShareOptions() {
            closeModal();
            document.getElementById('shareModal').classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) closeModal();
            });
        });

        // ========== STATUS MESSAGES ==========
        function showStatus(message, duration = 2500) {
            $.statusMsg.textContent = message;
            $.statusMsg.classList.add('active');
            setTimeout(() => $.statusMsg.classList.remove('active'), duration);
        }

        // ========== AI REFINEMENT ==========
        async function refineText(mode) {
            closeModal();
            const text = $.editor.innerText.trim();
            
            if (!text) {
                showStatus('No text to refine!');
                return;
            }

            $.refineBtn.disabled = true;
            $.refineBtn.innerHTML = '<span>‚è≥</span><span>Refining...</span>';
            showStatus('AI is refining your text...', 30000);

            try {
                const response = await fetch(`${API_URL}/api/refine`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ text, mode })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Refinement failed');
                }

                const data = await response.json();
                $.editor.innerText = data.refined;
                updateWordCount();
                showStatus('‚ú® Text refined successfully!');

            } catch (error) {
                console.error('Refinement error:', error);
                let errorMsg = error.message;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'Cannot connect to AI server. Check your internet connection.';
                }
                
                showStatus('‚ùå ' + errorMsg);
            } finally {
                $.refineBtn.disabled = false;
                $.refineBtn.innerHTML = '<span>‚ú®</span><span>Refine Writing</span>';
            }
        }

        // ========== HISTORY ==========
        function loadHistory() {
            if (history.length === 0) {
                $.historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div>No saved documents yet</div>
                    </div>
                `;
                $.historyHeaderBar.style.display = 'none';
                return;
            }

            $.historyHeaderBar.style.display = 'flex';
            $.historyList.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="history-item-content" onclick="loadHistoryItem(${item.id})">
                        <div class="history-item-title">${item.subject}</div>
                        <div class="history-item-preview">${item.content.substring(0, 80)}...</div>
                        <div class="history-item-date">${new Date(item.date).toLocaleDateString()}</div>
                    </div>
                    <button class="history-delete-btn" onclick="event.stopPropagation(); deleteHistoryItem(${item.id})" title="Delete">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        function loadHistoryItem(id) {
            const item = history.find(h => h.id === id);
            if (item) {
                $.subject.value = item.subject;
                $.editor.innerText = item.content;
                updateWordCount();
                closeModal();
                showStatus('‚úì Document loaded');
            }
        }

        function deleteHistoryItem(id) {
            if (confirm('Delete this document?')) {
                history = history.filter(h => h.id !== id);
                localStorage.setItem('signalwrite_history', JSON.stringify(history));
                loadHistory();
                showStatus('‚úì Document deleted');
            }
        }

        function clearAllHistory() {
            if (confirm('Delete ALL documents? This cannot be undone!')) {
                history = [];
                localStorage.removeItem('signalwrite_history');
                loadHistory();
                showStatus('‚úì All history cleared');
            }
        }

        // ========== EXPORT PDF ==========
        function exportPDF() {
            closeModal();
            const subject = $.subject.value.trim();
            const content = $.editor.innerText.trim();
            
            if (!subject && !content) {
                showStatus('Nothing to export!');
                return;
            }

            showStatus('Creating PDF...', 5000);

            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const margin = 20;
                    const pageWidth = 170;
                    const lineHeight = 7;
                    let y = margin;

                    // Title
                    if (subject) {
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        const titleLines = doc.splitTextToSize(subject, pageWidth);
                        titleLines.forEach(line => {
                            if (y > 270) {
                                doc.addPage();
                                y = margin;
                            }
                            doc.text(line, margin, y);
                            y += 9;
                        });
                        y += 10;
                    }

                    // Content
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');

                    const paragraphs = content.split('\n\n');
                    paragraphs.forEach(para => {
                        if (!para.trim()) return;
                        
                        const lines = doc.splitTextToSize(para.trim(), pageWidth);
                        lines.forEach(line => {
                            if (y > 270) {
                                doc.addPage();
                                y = margin;
                            }
                            doc.text(line, margin, y);
                            y += lineHeight;
                        });
                        y += 4;
                    });

                    // Footer
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(9);
                        doc.setTextColor(120);
                        doc.text(`Page ${i} of ${pageCount}`, 105, 287, { align: 'center' });
                        doc.text('SignalWrite', margin, 287);
                        doc.setTextColor(0);
                    }

                    const filename = (subject || 'document').replace(/[^a-z0-9]/gi, '_').substring(0, 30).toLowerCase() + '.pdf';
                    doc.save(filename);
                    
                    showStatus('‚úì PDF exported successfully!');
                } catch (error) {
                    console.error('PDF error:', error);
                    showStatus('‚ùå PDF export failed');
                }
            }, 100);
        }

        // ========== EXPORT DOCX ==========
        async function exportDOCX() {
            closeModal();
            const subject = $.subject.value.trim();
            const content = $.editor.innerText.trim();
            
            if (!subject && !content) {
                showStatus('Nothing to export!');
                return;
            }

            showStatus('Creating Word document...', 5000);

            try {
                const { Document, Paragraph, TextRun, HeadingLevel } = docx;
                const children = [];

                if (subject) {
                    children.push(new Paragraph({
                        text: subject,
                        heading: HeadingLevel.HEADING_1,
                        spacing: { after: 400 }
                    }));
                }

                const paragraphs = content.split('\n\n');
                paragraphs.forEach(para => {
                    if (para.trim()) {
                        children.push(new Paragraph({
                            children: [new TextRun(para.trim())],
                            spacing: { after: 200 }
                        }));
                    }
                });

                const doc = new Document({
                    sections: [{ properties: {}, children }]
                });

                const blob = await docx.Packer.toBlob(doc);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const filename = (subject || 'document').replace(/[^a-z0-9]/gi, '_').substring(0, 30).toLowerCase() + '.docx';
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                
                showStatus('‚úì Word document exported!');
            } catch (error) {
                console.error('DOCX error:', error);
                showStatus('‚ùå Word export failed');
            }
        }

        // ========== PRINT ==========
        function printDocument() {
            closeModal();
            if (!$.editor.innerText.trim() && !$.subject.value.trim()) {
                showStatus('Nothing to print!');
                return;
            }
            window.print();
        }

        // ========== SHARING ==========
        function getShareText() {
            const subject = $.subject.value.trim();
            const content = $.editor.innerText.trim();
            return subject ? `${subject}\n\n${content}` : content;
        }

        function shareToWhatsApp() {
            const text = encodeURIComponent(getShareText());
            window.open(`https://wa.me/?text=${text}`, '_blank');
            closeModal();
        }

        function shareToTwitter() {
            const text = encodeURIComponent(getShareText().substring(0, 280));
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
            closeModal();
        }

        function shareToFacebook() {
            const text = encodeURIComponent(getShareText());
            window.open(`https://www.facebook.com/sharer/sharer.php?quote=${text}`, '_blank');
            closeModal();
        }

        function shareToInstagram() {
            closeModal();
            copyToClipboard();
            showStatus('Text copied! Paste it in Instagram.');
        }

        async function copyToClipboard() {
            try {
                await navigator.clipboard.writeText(getShareText());
                showStatus('‚úì Copied to clipboard!');
                closeModal();
            } catch (error) {
                showStatus('‚ùå Failed to copy');
            }
        }

        // ========== KEYBOARD SHORTCUTS ==========
        document.addEventListener('keydown', e => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'b':
                        e.preventDefault();
                        document.execCommand('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        document.execCommand('italic');
                        break;
                    case 'p':
                        e.preventDefault();
                        printDocument();
                        break;
                }
            }
        });

        // ========== INITIALIZATION ==========
        updateWordCount();
        loadHistory();
        console.log('SignalWrite Professional Editor initialized');
    </script>
</body>
    </html>
